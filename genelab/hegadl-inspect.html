<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jDev GeneLab - HEGADL</title>

    <meta name="author" content="JanCraft">
    <meta name="description" content="jDev GeneLab - Human External Gene Aggregation Database and Laboratory">
    
    <link rel="shortcut icon" href="/img/favicon.png" type="image/png">
    <style>
        html, body {
            font-family: sans-serif;
            background: #333;
            color: #fff;
            margin: 0;
        }

        h2 {
            background-color: #046DAA;
            margin: 0;
            padding: 1rem;
        }
        #subjectid, #content {
            margin: 1rem;
        }

        canvas {
            background: #222;
            margin-left: .2rem;
            margin-bottom: .5rem;
        }
    </style>
</head>
<body>
    <h2>GeneLab HEGADL Inspector</h2>
    <h4 id="subjectid"></h4>

    <div id="content"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-app.js";
        import { getFirestore, collection, getDoc, doc } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-firestore.js";
        const params = new URLSearchParams(location.search);

        const biogenders = {
            'm': 'Macho',
            'f': 'Hembra',
            'i': 'Intersexual'
        }

        function keytoname(key) {
            return {
                N: "Marrón",
                B: "Azul",
                H: "Avellana",
                G: "Gris",
                E: "Verde",
                A: "Ámbar",
                K: "Negro",
                W: "Marrón Profundo",
                U: "Marrón-Rojizo",
                R: "Rojo",
                L: "Rubio",
                Y: "Amarillo Profundo",
                F: "Amarillo",
                T: "Claro",
                I: "Blanco / Pálido",
                '?': "N/A",
                "/": "Liso",
                "~": "Ondulado",
                "&": "Rizado",
                "#": "Afro-texturizado",
                "0": "Ovalado",
                O: "Redondo",
                "@": "Cuadrado",
                "<": "Rombo",
                "^": "Punta hacia Arriba",
                "_": "Punta hacia Abajo",
                X: "No",
                "-": "Pocas",
                "+": "Muchas"
            }[key];
        }

        function keytocolor(key) {
            return {
                N: "#6e4928",
                B: "#90c6ff",
                H: "#a8aa44",
                G: "#b6bccf",
                E: "#86d190",
                A: "#ae7420",
                K: "#222",
                W: "#573518",
                U: "#701616",
                R: "#c23f02",
                L: "#fff59b",
                Y: "#dca405",
                F: "#efcf78",
                T: "#fde2cc",
                I: "#fff"
            }[key];
        }

        function cap(s) {
            return s[0].toUpperCase() + s.substr(1);
        }

        const eye_rarity = {
            N: .8,
            B: .1,
            H: .05,
            G: .03,
            E: .02,
            A: .001
        };

        const hair_rarity = {
            K: .9,
            W: .8,
            N: .11,
            U: .02,
            R: .01,
            L: .03,
            G: .25
        };

        const skin_rarity = {
            W: .024,
            N: .213,
            Y: .274,
            F: .293,
            T: .196,
            I: .196
        };

        const firebaseConfig = {
            apiKey: "AIzaSyBUAk_ApThWMffxak1sYr9hPowFM4MY7zc",
            authDomain: "jdev-genelab-hegadl.firebaseapp.com",
            projectId: "jdev-genelab-hegadl",
            storageBucket: "jdev-genelab-hegadl.appspot.com",
            messagingSenderId: "424059033160",
            appId: "1:424059033160:web:511a667551feb72f466a7d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore();

        document.getElementById('subjectid').innerHTML = `Subject #${params.get('id')}<br>Loading...`;

        const docRef = doc(db, 'aggregation', params.get('id'));
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            window.originaldat = data

            const rarity = eye_rarity[data.facial[0]] * hair_rarity[data.facial[1]] * skin_rarity[data.facial[2]] * ((data.facial[5] == '-' || data.facial[5] == '+') ? .16 : 1);

            document.getElementById('subjectid').innerHTML = `Sujeto #${params.get('id')}<br>${data.fullname}`;
            document.getElementById('content').innerHTML = `
                <div><b>Género Biológico</b> <i>${biogenders[data.biogender]}</i></div>
                <div><b>Edad</b> <i>${data.age}</i></div>
                <div><b>País</b> <i>${data.country}</i></div>
                <div><b>Altura</b> <i>${data.height} cm</i></div>
                <div><b>Clasificador facial</b> <i>${data.facial}</i></div>
                <br>
                <div><b>Color de Ojos</b> <i>${cap(keytoname(data.facial[0]))}</i></div>
                <div><b>Color de Pelo</b> <i>${cap(keytoname(data.facial[1]))}</i></div>
                <div><b>Color de Piel</b> <i>${cap(keytoname(data.facial[2]))}</i></div>

                <div><b>Forma de la Cara</b> <i>${cap(keytoname(data.facial[3]))}</i></div>
                <div><b>Forma de los Ojos</b> <i>${cap(keytoname(data.facial[4]))}</i></div>
                <div><b>Pecas</b> <i>${cap(keytoname(data.facial[5]))}</i></div>
                <br>
                <div><b>Rareza de Rasgos</b> <i>${(rarity * 100).toFixed(2)}%</i></div>
                <br><br>

                <div style="display:flex">
                    <canvas id="facecnv" width="400" height="400"></canvas>
                    <canvas hidden id="facecnv2" width="400" height="400"></canvas>
                </div>

                <input id="otherid" type="number" min="0" autocomplete="off" placeholder="# de otro Sujeto">
                <button onclick="mix()">Mezclar</button>
            `;

            const ctx = document.getElementById('facecnv').getContext('2d');
            render_face(data.facial, ctx, `#${params.get('id')}`);

            console.log(data);
        } else {
            window.close();
        }

        function render_face(face, ctx, info="render_face()") {
            ctx.clearRect(0, 0, 400, 400);
            ctx.fillStyle = keytocolor(face[2]);

            //ctx.fillRect(15, 15, 20, 20);

            ctx.strokeStyle = "#fff";
            ctx.strokeWidth = 1;
            ctx.strokeText(info, 6, 400-16);

            ctx.save();
            {
                ctx.translate(200, 200);
                ctx.rotate(-45 * Math.PI / 180);
                ctx.font = "32px sans-serif";
                ctx.strokeText("IN DEVELOPMENT", -100, 10);
            }
            ctx.restore();
        }

        function mixgenes(a, b) {
            let c = "";
            for (let i = 0; i < a.length; i++) {
                c += Math.random() < .5 ? a[i] : b[i];
            }
            return c;
        }

        window.mix = async () => {
            const otherid = document.getElementById('otherid').value;
            if (otherid.trim() == "") return;

            const docRef = doc(db, 'aggregation', otherid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();

                const mixed = mixgenes(window.originaldat.facial, data.facial);

                document.getElementById('facecnv2').hidden = false;
                const ctx = document.getElementById('facecnv2').getContext('2d');
                render_face(mixed, ctx, "Mezclado");
            }
        }
    </script>
</body>
</html>